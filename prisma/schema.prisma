// ===============================================
// DATASOURCE & GENERATORS
// ===============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===============================================
// ENUMS (1:1 con PostgreSQL)
// ===============================================

enum user_role {
  admin
  teacher
  student
}

enum user_status {
  active
  banned
  pending_verification
}

enum teacher_application_status {
  pending
  approved
  rejected
}

enum subscription_status {
  active
  expired
  cancelled
}

enum payment_type {
  course
  subscription
}

enum payment_status {
  pending
  completed
  failed
}

enum enrollment_status {
  active
  completed
  cancelled
}

enum notification_type {
  system
  course
  payment
  personal
}

// ===============================================
// MODELS — TABLAS DE USUARIOS
// ===============================================

model users {
  id            String      @id @default(uuid()) @db.Uuid
  first_name    String
  last_name     String
  email         String      @unique
  birthdate     DateTime?   @db.Date
  password_hash String
  role          user_role   @default(student)
  timezone      String?
  status        user_status @default(active)
  created_at    DateTime    @default(now())
  updated_at    DateTime    @default(now())

  teacher              teachers?
  student              students?
  refreshTokens        refresh_tokens[]
  payments             payments[]
  cards                cards[]
  notifications        notifications[]
  chatMessages         live_chat_messages[]
  teachersApplications teachers_applications[]
}

// TEACHERS
model teachers {
  id                   String   @id @default(uuid()) @db.Uuid
  user_id              String   @unique @db.Uuid
  image_url            String?
  bio                  String?
  specialty            String?
  experience           String?
  portfolio_url        String?
  rating               Decimal? @default(0) @db.Decimal(3, 2)
  active_courses_count Int      @default(0)
  created_at           DateTime @default(now())
  updated_at           DateTime @default(now())

  user          users                   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  subscriptions teacher_subscriptions[]
  courses       courses[]
}

// TEACHER APPLICATIONS
model teachers_applications {
  id            String                     @id @default(uuid()) @db.Uuid
  user_id       String                     @unique @db.Uuid
  bio           String?
  specialty     String?
  experience    String?
  portfolio_url String?
  status        teacher_application_status @default(pending)
  admin_comment String?
  created_at    DateTime                   @default(now())
  updated_at    DateTime                   @default(now())

  user       users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

// STUDENTS
model students {
  id             String   @id @default(uuid()) @db.Uuid
  user_id        String   @unique @db.Uuid
  image_url      String?
  bio            String?
  academy        String?
  academic_level String?
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now())

  user        users                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  enrollments course_enrollments[]
  reviews     course_reviews[]
  comments    class_comments[]
  progress    lesson_progress[]
}

// ===============================================
// SESIONES / AUTENTICACIÓN
// ===============================================

model refresh_tokens {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique
  user_agent String?
  ip_address String?
  created_at DateTime @default(now())
  expires_at DateTime

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

// ===============================================
// SUSCRIPCIONES Y PAGOS
// ===============================================

model subscriptions {
  id                      String   @id @default(uuid()) @db.Uuid
  name                    String
  price                   Decimal  @db.Decimal(10, 2)
  max_courses             Int      @default(1)
  max_students_per_course Int      @default(50)
  features                Json     @default("{}")
  created_at              DateTime @default(now())
  updated_at              DateTime @default(now())

  teacherSubs teacher_subscriptions[]
}

model payments {
  id         String         @id @default(uuid()) @db.Uuid
  user_id    String?        @db.Uuid
  amount     Decimal        @db.Decimal(10, 2)
  type       payment_type
  reference  String?
  status     payment_status @default(pending)
  created_at DateTime       @default(now())
  updated_at DateTime       @default(now())

  user        users?                  @relation(fields: [user_id], references: [id], onDelete: SetNull)
  teacherSubs teacher_subscriptions[]
  enrollments course_enrollments[]
}

model teacher_subscriptions {
  id              String              @id @default(uuid()) @db.Uuid
  teacher_id      String              @db.Uuid
  subscription_id String              @db.Uuid
  payment_id      String?             @db.Uuid
  start_date      DateTime            @db.Date
  end_date        DateTime?           @db.Date
  status          subscription_status @default(active)

  teacher      teachers      @relation(fields: [teacher_id], references: [id], onDelete: Cascade)
  subscription subscriptions @relation(fields: [subscription_id], references: [id], onDelete: Cascade)
  payment      payments?     @relation(fields: [payment_id], references: [id], onDelete: SetNull)
}

model cards {
  id      String @id @default(uuid()) @db.Uuid
  user_id String @db.Uuid

  brand        String
  last4        String @db.VarChar(4)
  expire_month Int
  expire_year  Int

  balance Decimal @default(0) @db.Decimal(10, 2)

  label     String?
  is_active Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

// ===============================================
// CURSOS
// ===============================================

model courses {
  id           String   @id @default(uuid()) @db.Uuid
  teacher_id   String   @db.Uuid
  title        String
  description  String?
  category     String?
  price        Decimal? @default(0) @db.Decimal(10, 2)
  color        String?
  cover_url    String?
  level        String?
  duration     String?
  max_students Int      @default(50)
  schedule     Json     @default("{}")
  settings     Json     @default("{}")
  is_active    Boolean  @default(true)
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())

  teacher      teachers             @relation(fields: [teacher_id], references: [id], onDelete: Cascade)
  enrollments  course_enrollments[]
  reviews      course_reviews[]
  comments     class_comments[]
  lessons      lessons[]
  liveSessions live_sessions[]
}

// ENROLLMENTS
model course_enrollments {
  id          String            @id @default(uuid()) @db.Uuid
  course_id   String            @db.Uuid
  student_id  String            @db.Uuid
  payment_id  String?           @db.Uuid
  status      enrollment_status @default(active)
  enrolled_at DateTime          @default(now())
  updated_at  DateTime          @default(now())

  course  courses   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  student students  @relation(fields: [student_id], references: [id], onDelete: Cascade)
  payment payments? @relation(fields: [payment_id], references: [id], onDelete: SetNull)

  @@unique([course_id, student_id])
}

// REVIEWS
model course_reviews {
  id         String   @id @default(uuid()) @db.Uuid
  course_id  String   @db.Uuid
  student_id String   @db.Uuid
  rating     Int
  comment    String?
  created_at DateTime @default(now())

  course  courses  @relation(fields: [course_id], references: [id], onDelete: Cascade)
  student students @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@unique([course_id, student_id])
}

// COMMENTS
model class_comments {
  id         String   @id @default(uuid()) @db.Uuid
  course_id  String   @db.Uuid
  student_id String   @db.Uuid
  comment    String
  created_at DateTime @default(now())

  course  courses  @relation(fields: [course_id], references: [id], onDelete: Cascade)
  student students @relation(fields: [student_id], references: [id], onDelete: Cascade)
}

// ===============================================
// LESSONS
// ===============================================

model lessons {
  id         String   @id @default(uuid()) @db.Uuid
  course_id  String   @db.Uuid
  title      String
  content    String?
  video_url  String?
  file_url   String?
  position   Int
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  course   courses           @relation(fields: [course_id], references: [id], onDelete: Cascade)
  progress lesson_progress[]

  @@unique([course_id, position])
}

model lesson_progress {
  id           String    @id @default(uuid()) @db.Uuid
  lesson_id    String    @db.Uuid
  student_id   String    @db.Uuid
  is_completed Boolean   @default(false)
  completed_at DateTime?

  lesson  lessons  @relation(fields: [lesson_id], references: [id], onDelete: Cascade)
  student students @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@unique([lesson_id, student_id])
}

// ===============================================
// NOTIFICATIONS
// ===============================================

model notifications {
  id         String            @id @default(uuid()) @db.Uuid
  user_id    String            @db.Uuid
  title      String
  message    String
  type       notification_type @default(system)
  is_read    Boolean           @default(false)
  created_at DateTime          @default(now())
  updated_at DateTime          @default(now())

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

// ===============================================
// LIVE SESSIONS
// ===============================================

model live_sessions {
  id          String    @id @default(uuid()) @db.Uuid
  course_id   String    @db.Uuid
  session_url String
  start_time  DateTime
  end_time    DateTime?
  is_active   Boolean   @default(true)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @default(now())

  course   courses              @relation(fields: [course_id], references: [id], onDelete: Cascade)
  messages live_chat_messages[]
}

model live_chat_messages {
  id         String   @id @default(uuid()) @db.Uuid
  session_id String   @db.Uuid
  sender_id  String   @db.Uuid
  message    String
  sent_at    DateTime @default(now())
  is_deleted Boolean  @default(false)

  session live_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)
  sender  users         @relation(fields: [sender_id], references: [id], onDelete: Cascade)
}
